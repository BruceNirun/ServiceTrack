@page "/"

@inject NavigationManager NavManager

@* ใช้ MudContainer เพื่อครอบเนื้อหาทั้งหมดและเว้นระยะห่างจากขอบ *@
<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">

    @* ============================================================= *@
    @* === ส่วนปุ่มเลือก Role (ทำงานแบบ Navigation) === *@
    @* ============================================================= *@
    <MudPaper Elevation="0" Class="d-flex align-center mb-4">
        <MudButtonGroup Color="Color.Primary" OverrideStyles="false">
            @* ปุ่มผู้แจ้งซ่อม *@
            <MudButton Variant="@(_selectedRole == "Requester" ? Variant.Filled : Variant.Text)"
                       OnClick="@(() => SelectRole("Requester"))"
                       Class="px-3 mr-2">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Outlined.PersonOutline" Class="mr-3"/>
                    <div>
                        <MudText Typo="Typo.body1" Align="Align.Left" Style="line-height: 1.2; font-weight: 500;">ผู้แจ้งซ่อม</MudText>
                        <MudText Typo="Typo.caption" Align="Align.Left" Style="line-height: 1;">แจ้งปัญหา/ติดตามสถานะ</MudText>
                    </div>
                </div>
            </MudButton>

            @* ปุ่มทีมช่าง *@
            <MudButton Variant="@(_selectedRole == "Technician" ? Variant.Filled : Variant.Text)"
                       OnClick="@(() => SelectRole("Technician"))"
                       Class="px-3 mr-2">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Outlined.Build" Class="mr-3"/>
                    <div>
                        <MudText Typo="Typo.body1" Align="Align.Left" Style="line-height: 1.2; font-weight: 500;">ทีมช่าง</MudText>
                        <MudText Typo="Typo.caption" Align="Align.Left" Style="line-height: 1;">รับงาน/ปิดเคส/รายงาน</MudText>
                    </div>
                </div>
            </MudButton>

            @* ปุ่มผู้ดูแลระบบ (แบบเลือกอยู่) *@
            <MudButton Variant="@(_selectedRole == "Admin" ? Variant.Filled : Variant.Text)"
                       OnClick="@(() => SelectRole("Admin"))"
                       Class="px-3">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Outlined.AdminPanelSettings" Class="mr-3"/>
                    <div>
                        <MudText Typo="Typo.body1" Align="Align.Left" Style="line-height: 1.2; font-weight: 500;">ผู้ดูแลระบบ</MudText>
                        <MudText Typo="Typo.caption" Align="Align.Left" Style="line-height: 1;">จัดการระบบ/รายงาน</MudText>
                    </div>
                </div>
            </MudButton>
        </MudButtonGroup>
    </MudPaper>

    @* ============================================================= *@
    @* === แสดงเนื้อหาตาม Role ที่เลือก === *@
    @* ============================================================= *@
    @if (_selectedRole == "Admin")
    {
        @* 1. ส่วนแท็บเมนูหลัก *@
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="mt-6">
            <MudTabPanel Text="หลัก" Icon="@Icons.Material.Filled.Dashboard" />
            <MudTabPanel Text="ปฏิทิน" Icon="@Icons.Material.Filled.CalendarToday" />
            <MudTabPanel Text="ทรัพย์สิน" Icon="@Icons.Material.Filled.BusinessCenter" />
        </MudTabs>

        @* 2. ส่วนหัวของ Dashboard *@
        <div class="d-flex align-center mt-6">
            <div>
                <MudText Typo="Typo.h5">แดชบอร์ดผู้ดูแลระบบ</MudText>
                <MudText Typo="Typo.body2" Color="Color.Inherit">ภาพรวมและการวิเคราะห์ระบบแจ้งซ่อม</MudText>
            </div>
            <MudSpacer />
            <MudSelect T="string" Label="เดือนนี้" Variant="Variant.Outlined" Dense="true" Class="mr-2" Style="width: 150px;">
                <MudSelectItem Value='"this_month"'>เดือนนี้</MudSelectItem>
                <MudSelectItem Value='"last_month"'>เดือนที่แล้ว</MudSelectItem>
            </MudSelect>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Settings">ตั้งค่า</MudButton>
        </div>

        @* 3. การ์ดแสดงข้อมูลสรุป *@
        <MudGrid Spacing="3" Class="mt-4">
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4 d-flex align-center" Style="background-color: #2196F3; color: white; border-radius: 12px;">
                    <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Large" Class="mr-4"/>
                    <div>
                        <MudText Typo="Typo.h6">2</MudText>
                        <MudText Typo="Typo.body2">คำขอทั้งหมด</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                 <MudPaper Class="pa-4 d-flex align-center" Style="background-color: #4CAF50; color: white; border-radius: 12px;">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Class="mr-4"/>
                    <div>
                        <MudText Typo="Typo.h6">50%</MudText>
                        <MudText Typo="Typo.body2">อัตราความสำเร็จ</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4 d-flex align-center" Style="background-color: #FF9800; color: white; border-radius: 12px;">
                    <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Large" Class="mr-4"/>
                    <div>
                        <MudText Typo="Typo.h6">13651.1</MudText>
                        <MudText Typo="Typo.body2">เวลาเฉลี่ย (ชม.)</MudText>
                    </div>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                 <MudPaper Class="pa-4 d-flex align-center" Style="background-color: #9C27B0; color: white; border-radius: 12px;">
                    <MudIcon Icon="@Icons.Material.Filled.PendingActions" Size="Size.Large" Class="mr-4"/>
                    <div>
                        <MudText Typo="Typo.h6">0</MudText>
                        <MudText Typo="Typo.body2">รอดำเนินการ</MudText>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>

        @* 4. การ์ดแสดงกราฟ *@
        <MudGrid Spacing="3" Class="mt-4">
            <MudItem xs="12" lg="7">
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; height: 100%;">
                    <MudText Typo="Typo.h6" GutterBottom="true">การแจ้งซ่อมตามหมวดหมู่</MudText>
                    <MudChart ChartType="ChartType.Bar" ChartSeries="@_categorySeries" XAxisLabels="@_categoryLabels" Height="350px" />
                </MudPaper>
            </MudItem>
            <MudItem xs="12" lg="5">
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; height: 100%;">
                    <MudText Typo="Typo.h6" GutterBottom="true">ระดับความสำคัญ</MudText>
                    <MudChart ChartType="ChartType.Donut" InputData="@_priorityData" InputLabels="@_priorityLabels" Height="350px" />
                </MudPaper>
            </MudItem>
        </MudGrid>
        
        @* 5. สถานะงานซ่อมล่าสุด *@
        <MudPaper Elevation="2" Class="pa-4 mt-6" Style="border-radius: 12px;">
            <MudText Typo="Typo.h6" GutterBottom="true">สถานะงานซ่อมล่าสุด</MudText>
            <MudGrid Spacing="3" Class="mt-2">
                <MudItem xs="12" sm="4">
                    <MudPaper Elevation="0" Class="pa-4 text-center" Style="background-color: #FFF9C4; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Style="color: #FBC02D;" />
                        <MudText Typo="Typo.h5" Class="mt-2">0</MudText>
                        <MudText Typo="Typo.body2">รอดำเนินการ</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Elevation="0" Class="pa-4 text-center" Style="background-color: #FFECB3; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Filled.WarningAmber" Style="color: #FFA000;" />
                        <MudText Typo="Typo.h5" Class="mt-2">1</MudText>
                        <MudText Typo="Typo.body2">กำลังดำเนินการ</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudPaper Elevation="0" Class="pa-4 text-center" Style="background-color: #C8E6C9; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircleOutline" Style="color: #388E3C;" />
                        <MudText Typo="Typo.h5" Class="mt-2">1</MudText>
                        <MudText Typo="Typo.body2">เสร็จสิ้น</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* 6. ตารางคำขอซ่อมล่าสุด *@
        <MudPaper Elevation="2" Class="pa-4 mt-6" Style="border-radius: 12px;">
            <MudText Typo="Typo.h6" GutterBottom="true">คำขอซ่อมล่าสุด</MudText>
            <MudTable Items="@_latestRequests" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="0">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>หัวข้อ</MudTh>
                    <MudTh>หมวดหมู่</MudTh>
                    <MudTh>สถานะ</MudTh>
                    <MudTh>ผู้แจ้ง</MudTh>
                    <MudTh>วันที่</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID"><MudLink Href="#">@context.Id</MudLink></MudTd>
                    <MudTd DataLabel="หัวข้อ">@context.Topic</MudTd>
                    <MudTd DataLabel="หมวดหมู่">@context.Category</MudTd>
                    <MudTd DataLabel="สถานะ">
                        <MudChip T="string" Label="true" Color="@GetStatusColor(context.Status)" Size="Size.Small">@context.Status</MudChip>
                    </MudTd>
                    <MudTd DataLabel="ผู้แจ้ง">@context.Requester</MudTd>
                    <MudTd DataLabel="วันที่">@context.Date</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
    else if (_selectedRole == "Requester")
    {
        <RequesterPage/>
    }
    else if (_selectedRole == "Technician")
    {
        <TechnicianPage/>
    }

</MudContainer>

@code {
    private string _selectedRole;

    protected override void OnInitialized()
    {
        // ตรวจสอบ URL ปัจจุบันเพื่อกำหนด Role ที่เลือก
        var currentUri = NavManager.ToAbsoluteUri(NavManager.Uri).AbsolutePath;
        switch (currentUri)
        {
            case "/requester":
                _selectedRole = "Requester";
                break;
            case "/technician":
                _selectedRole = "Technician";
                break;
            case "/":
            default:
                _selectedRole = "Admin";
                break;
        }
    }

    private void SelectRole(string role)
    {
        _selectedRole = role;
        // ไม่ต้อง Navigate แล้ว เพราะเราใช้ @if แสดงผลในหน้าเดียวกัน
    }

    // --- โค้ดเดิมสำหรับกราฟ ---
    private List<ChartSeries> _categorySeries = new List<ChartSeries>()
    {
        new ChartSeries() { Name = "จำนวน", Data = new double[] { 1, 0, 0, 1, 0, 0, 0 } }
    };
    private string[] _categoryLabels = { "ฮาร์ดแวร์", "ซอฟต์แวร์", "เครือข่าย", "สิ่งอำนวยความสะดวก", "เฟอร์นิเจอร์", "ระบบไฟฟ้า", "อื่นๆ" };
    private double[] _priorityData = { 0, 1, 1, 0 };
    private string[] _priorityLabels = { "เร่งด่วน", "สูง", "ปานกลาง", "ต่ำ" };

    // --- โค้ดสำหรับตาราง ---
    private IEnumerable<RepairRequest> _latestRequests = new List<RepairRequest>
    {
        new RepairRequest { Id = "#T001", Topic = "คอมพิวเตอร์เปิดไม่ติด", Category = "hardware", Status = "เสร็จสิ้น", Requester = "สมชาย ใจดี", Date = "15/1/2567" },
        new RepairRequest { Id = "#T002", Topic = "เครื่องปรับอากาศไม่เย็น", Category = "facility", Status = "รอมอบหมายงาน", Requester = "สมหญิง รักงาน", Date = "15/1/2567" }
    };

    public class RepairRequest
    {
        public string Id { get; set; }
        public string Topic { get; set; }
        public string Category { get; set; }
        public string Status { get; set; }
        public string Requester { get; set; }
        public string Date { get; set; }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "เสร็จสิ้น" => Color.Success,
            "รอมอบหมายงาน" => Color.Info,
            "กำลังดำเนินการ" => Color.Warning,
            "ยกเลิก" => Color.Error,
            _ => Color.Default
        };
    }
}
